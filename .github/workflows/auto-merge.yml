name: Auto Merge

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed
    branches:
      - feature/unit-test

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
        
    - name: Create Pull Request
      id: create-pr
      uses: repo-sync/pull-request@v2
      with:
        source_branch: feature/unit-test
        destination_branch: master
        github_token: ${{ secrets.GITHUB_TOKEN }}
        pr_title: "è‡ªå‹•ãƒãƒ¼ã‚¸: ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆå®Ÿè£…ã¨CI/CDæ§‹ç¯‰"
        pr_body: |
          ## ğŸ¤– è‡ªå‹•ç”Ÿæˆãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
          
          ã“ã®PRã¯è‡ªå‹•çš„ã«ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚ä»¥ä¸‹ã®å¤‰æ›´ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ï¼š
          
          ### âœ… å®Ÿè£…å†…å®¹
          - Jasmineãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆå®Ÿè£…ï¼ˆGitHubService, RepositoryStoreï¼‰
          - DockeråŒ–ã•ã‚ŒãŸCI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³æ§‹ç¯‰
          - ã‚³ãƒ¼ãƒ‰ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆï¼ˆ62.76% statements, 63.81% functionsï¼‰
          - GitHub Actionsè‡ªå‹•ãƒ†ã‚¹ãƒˆå®Ÿè¡Œç’°å¢ƒ
          - WSL2å¯¾å¿œã®ãƒ†ã‚¹ãƒˆç’°å¢ƒæ§‹ç¯‰
          
          ### ğŸ§ª ãƒ†ã‚¹ãƒˆçŠ¶æ³
          - âœ… 89 specs, 0 failures
          - âœ… CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³æˆåŠŸ
          - âœ… Dockerç’°å¢ƒã§ã®ãƒ˜ãƒƒãƒ‰ãƒ¬ã‚¹ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
          - âœ… ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ãƒ“ãƒ«ãƒ‰æˆåŠŸ
          
          ### ğŸ“ˆ ã‚³ãƒ¼ãƒ‰å“è³ªå‘ä¸Š
          - å˜ä½“ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸å°å…¥
          - ç¶™ç¶šçš„ã‚¤ãƒ³ãƒ†ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ§‹ç¯‰
          - è‡ªå‹•åŒ–ã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯
          
          CIãŒæˆåŠŸã—ãŸãŸã‚è‡ªå‹•çš„ã«ãƒãƒ¼ã‚¸ã•ã‚Œã¾ã™ã€‚
        pr_draft: false
        pr_allow_empty: false
        
    - name: Enable auto-merge
      if: steps.create-pr.outputs.pr_number
      run: |
        gh pr merge ${{ steps.create-pr.outputs.pr_number }} --auto --squash
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Wait and check merge status
      if: steps.create-pr.outputs.pr_number
      run: |
        echo "PRä½œæˆå®Œäº†: #${{ steps.create-pr.outputs.pr_number }}"
        echo "è‡ªå‹•ãƒãƒ¼ã‚¸ãŒæœ‰åŠ¹åŒ–ã•ã‚Œã¾ã—ãŸ"